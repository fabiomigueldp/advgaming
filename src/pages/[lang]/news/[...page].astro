---
/**
 * Blog Archive Pages with i18n Support
 * 
 * This file handles the paginated blog/news listing
 * with full internationalization support.
 */
import { getCollection, getEntry } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";
import Intersecting from "@components/common/Intersecting.vue";
import ItemCard from "@components/cards/ItemCard.astro";
import Pager from "@components/navigation/Pager.astro";
import { SUPPORTED_LOCALES, DEFAULT_LOCALE, type SupportedLocale } from "@util/translate";

export async function getStaticPaths({ paginate }) {
  const allPosts = await getCollection("blog");
  
  const paths = [];
  
  for (const locale of SUPPORTED_LOCALES) {
    // Get localized blog config
    let blogConfig;
    try {
      blogConfig = await getEntry("config", `${locale}/blog`);
    } catch {}
    if (!blogConfig) {
      blogConfig = await getEntry("config", "blog");
    }
    const { data } = blogConfig;
    
    // Filter posts for this locale and sort by date
    const localePosts = allPosts
      .filter((post) => post.slug.startsWith(`${locale}/`))
      .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
    
    // Paginate the posts
    const paginatedPages = paginate(localePosts, { 
      pageSize: data.per_page,
      params: { lang: locale }
    });
    
    // Add locale to each page's props
    for (const page of paginatedPages) {
      paths.push({
        ...page,
        props: {
          ...page.props,
          lang: locale
        }
      });
    }
  }
  
  return paths;
}

interface Props {
  page: any;
  lang: SupportedLocale;
}

const { page, lang } = Astro.props;
const currentLang = lang || (Astro.params.lang as SupportedLocale);

// Base URL for blog, localized
const base_url = `/${currentLang}/${import.meta.env.BLOG_SLUG || "news"}`;

// Get localized blog config
let blogConfig;
try {
  blogConfig = await getEntry("config", `${currentLang}/blog`);
} catch {}
if (!blogConfig) {
  blogConfig = await getEntry("config", "blog");
}
const { data } = blogConfig;

// Get all posts for this locale to extract tags
const posts = (await getCollection("blog"))
  .filter((post) => post.slug.startsWith(`${currentLang}/`))
  .sort((a, b) => a.data.pubDate.valueOf() - b.data.pubDate.valueOf());

// Get the used tags
const allFilters = posts.map((post) => post.data.tag).filter((post) => !!post);
const filters = [...new Set(allFilters.flat(1))];

const sizes =
  "(max-width: 639px) calc(100vw - 4rem), (min-width: 1024px) 450px,  calc(50vw - 4rem )";
---

<PageLayout {...page} {...data} {filters} {base_url} lang={currentLang}>
  <section>
    <ul
      class={`grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-8 lg:gap-20 pb-20`}
    >
      {
        page.data.map((post) => (
          <li>
            <Intersecting client:visible>
              <ItemCard
                content={post}
                base_url={base_url}
                {sizes}
                animate={true}
                lang={currentLang}
              />
            </Intersecting>
          </li>
        ))
      }
    </ul>
    {
      page.lastPage > 1 && (
        <div class="container-md pb-4">
          <Pager
            totalPage={page.lastPage}
            currentPage={page.currentPage}
            url={base_url}
          />
        </div>
      )
    }
  </section>
</PageLayout>
